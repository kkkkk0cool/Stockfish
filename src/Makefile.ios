# Stockfish iOS Static Library Makefile
# ç”¨äºå°† Stockfish ç¼–è¯‘ä¸º iOS é™æ€åº“

# ç›®æ ‡
STATICLIB_DEVICE = libstockfish-ios.a
STATICLIB_SIM = libstockfish-sim.a
STATICLIB_UNIVERSAL = libstockfish.a

# iOS SDK è·¯å¾„
IOS_SDK = $(shell xcrun --sdk iphoneos --show-sdk-path)
SIM_SDK = $(shell xcrun --sdk iphonesimulator --show-sdk-path)

# ç¼–è¯‘å™¨
CXX_DEVICE = xcrun -sdk iphoneos clang++
CXX_SIM = xcrun -sdk iphonesimulator clang++
AR = ar

# æœ€ä½ iOS ç‰ˆæœ¬
IOS_MIN_VERSION = 13.0

# æºæ–‡ä»¶ (æ’é™¤ main.cpp)
SRCS = benchmark.cpp bitboard.cpp evaluate.cpp \
    misc.cpp movegen.cpp movepick.cpp position.cpp \
    search.cpp thread.cpp timeman.cpp tt.cpp uci.cpp ucioption.cpp tune.cpp \
    syzygy/tbprobe.cpp nnue/nnue_accumulator.cpp nnue/nnue_misc.cpp \
    nnue/network.cpp nnue/features/half_ka_v2_hm.cpp \
    nnue/features/full_threats.cpp engine.cpp score.cpp memory.cpp

# å¯¹è±¡æ–‡ä»¶
OBJS_DEVICE = $(SRCS:.cpp=.device.o)
OBJS_SIM = $(SRCS:.cpp=.sim.o)

# é€šç”¨ç¼–è¯‘æ ‡å¿—
CXXFLAGS_COMMON = -std=c++17 -O3 -DNDEBUG \
    -fno-exceptions -fno-rtti \
    -Wall -Wcast-qual \
    -DNNUE_EMBEDDING_OFF \
    -DIS_64BIT \
    -DUSE_POPCNT \
    -fvisibility=hidden

# iOS è®¾å¤‡ç¼–è¯‘æ ‡å¿— (arm64)
CXXFLAGS_DEVICE = $(CXXFLAGS_COMMON) \
    -arch arm64 \
    -isysroot $(IOS_SDK) \
    -mios-version-min=$(IOS_MIN_VERSION) \
    -DUSE_NEON=8 \
    -DUSE_NEON_DOTPROD \
    -march=armv8.2-a+dotprod \
    -fembed-bitcode

# iOS æ¨¡æ‹Ÿå™¨ç¼–è¯‘æ ‡å¿— (x86_64 + arm64)
CXXFLAGS_SIM = $(CXXFLAGS_COMMON) \
    -arch x86_64 -arch arm64 \
    -isysroot $(SIM_SDK) \
    -mios-simulator-version-min=$(IOS_MIN_VERSION)

# é»˜è®¤ç›®æ ‡
all: device

# ç¼–è¯‘ iOS è®¾å¤‡é™æ€åº“
device: $(STATICLIB_DEVICE)

$(STATICLIB_DEVICE): $(OBJS_DEVICE)
	$(AR) rcs $@ $^
	@echo "âœ… Built $(STATICLIB_DEVICE) for iOS device (arm64)"

%.device.o: %.cpp
	@mkdir -p $(dir $@)
	$(CXX_DEVICE) $(CXXFLAGS_DEVICE) -c $< -o $@

# ç¼–è¯‘ iOS æ¨¡æ‹Ÿå™¨é™æ€åº“
simulator: $(STATICLIB_SIM)

$(STATICLIB_SIM): $(OBJS_SIM)
	$(AR) rcs $@ $^
	@echo "âœ… Built $(STATICLIB_SIM) for iOS simulator"

%.sim.o: %.cpp
	@mkdir -p $(dir $@)
	$(CXX_SIM) $(CXXFLAGS_SIM) -c $< -o $@

# åˆ›å»ºé€šç”¨é™æ€åº“ (è®¾å¤‡ + æ¨¡æ‹Ÿå™¨)
universal: device simulator
	lipo -create $(STATICLIB_DEVICE) $(STATICLIB_SIM) -output $(STATICLIB_UNIVERSAL)
	@echo "âœ… Built universal $(STATICLIB_UNIVERSAL)"

# æ¸…ç†
clean:
	rm -f $(OBJS_DEVICE) $(OBJS_SIM)
	rm -f $(STATICLIB_DEVICE) $(STATICLIB_SIM) $(STATICLIB_UNIVERSAL)
	rm -f syzygy/*.o nnue/*.o nnue/features/*.o
	@echo "ğŸ§¹ Cleaned all build artifacts"

# æ˜¾ç¤ºå¸®åŠ©
help:
	@echo "Stockfish iOS Static Library Build"
	@echo ""
	@echo "Targets:"
	@echo "  device     - Build for iOS device (arm64)"
	@echo "  simulator  - Build for iOS simulator (x86_64 + arm64)"
	@echo "  universal  - Build universal library (device + simulator)"
	@echo "  clean      - Remove all build artifacts"
	@echo ""
	@echo "Output:"
	@echo "  $(STATICLIB_DEVICE)  - iOS device library"
	@echo "  $(STATICLIB_SIM)     - iOS simulator library"
	@echo "  $(STATICLIB_UNIVERSAL)  - Universal library"

.PHONY: all device simulator universal clean help
